<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!-- NewPage -->
<html lang="en">
<head>
<!-- Generated by javadoc (version 1.7.0_04) on Sun Sep 29 15:58:47 GMT+08:00 2013 -->
<title>RoleChanger</title>
<meta name="date" content="2013-09-29">
<link rel="stylesheet" type="text/css" href="../../../../stylesheet.css" title="Style">
</head>
<body>
<script type="text/javascript"><!--
    if (location.href.indexOf('is-external=true') == -1) {
        parent.document.title="RoleChanger";
    }
//-->
</script>
<noscript>
<div>JavaScript is disabled on your browser.</div>
</noscript>
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="topNav"><a name="navbar_top">
<!--   -->
</a><a href="#skip-navbar_top" title="Skip navigation links"></a><a name="navbar_top_firstrow">
<!--   -->
</a>
<ul class="navList" title="Navigation">
<li><a href="../../../../overview-summary.html">Overview</a></li>
<li><a href="package-summary.html">Package</a></li>
<li class="navBarCell1Rev">Class</li>
<li><a href="class-use/RoleChanger.html">Use</a></li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../../deprecated-list.html">Deprecated</a></li>
<li><a href="../../../../index-files/index-1.html">Index</a></li>
<li><a href="../../../../help-doc.html">Help</a></li>
</ul>
</div>
<div class="subNav">
<ul class="navList">
<li><a href="../../../../net/floodlightcontroller/core/internal/OpenflowPipelineFactory.html" title="class in net.floodlightcontroller.core.internal"><span class="strong">Prev Class</span></a></li>
<li><a href="../../../../net/floodlightcontroller/core/internal/RoleChanger.RoleChangeTask.html" title="class in net.floodlightcontroller.core.internal"><span class="strong">Next Class</span></a></li>
</ul>
<ul class="navList">
<li><a href="../../../../index.html?net/floodlightcontroller/core/internal/RoleChanger.html" target="_top">Frames</a></li>
<li><a href="RoleChanger.html" target="_top">No Frames</a></li>
</ul>
<ul class="navList" id="allclasses_navbar_top">
<li><a href="../../../../allclasses-noframe.html">All Classes</a></li>
</ul>
<div>
<script type="text/javascript"><!--
  allClassesLink = document.getElementById("allclasses_navbar_top");
  if(window==top) {
    allClassesLink.style.display = "block";
  }
  else {
    allClassesLink.style.display = "none";
  }
  //-->
</script>
</div>
<div>
<ul class="subNavList">
<li>Summary:&nbsp;</li>
<li><a href="#nested_class_summary">Nested</a>&nbsp;|&nbsp;</li>
<li><a href="#field_summary">Field</a>&nbsp;|&nbsp;</li>
<li><a href="#constructor_summary">Constr</a>&nbsp;|&nbsp;</li>
<li><a href="#method_summary">Method</a></li>
</ul>
<ul class="subNavList">
<li>Detail:&nbsp;</li>
<li><a href="#field_detail">Field</a>&nbsp;|&nbsp;</li>
<li><a href="#constructor_detail">Constr</a>&nbsp;|&nbsp;</li>
<li><a href="#method_detail">Method</a></li>
</ul>
</div>
<a name="skip-navbar_top">
<!--   -->
</a></div>
<!-- ========= END OF TOP NAVBAR ========= -->
<!-- ======== START OF CLASS DATA ======== -->
<div class="header">
<div class="subTitle">net.floodlightcontroller.core.internal</div>
<h2 title="Class RoleChanger" class="title">Class RoleChanger</h2>
</div>
<div class="contentContainer">
<ul class="inheritance">
<li>java.lang.Object</li>
<li>
<ul class="inheritance">
<li>net.floodlightcontroller.core.internal.RoleChanger</li>
</ul>
</li>
</ul>
<div class="description">
<ul class="blockList">
<li class="blockList">
<hr>
<br>
<pre>public class <span class="strong">RoleChanger</span>
extends java.lang.Object</pre>
<div class="block">This class handles sending of RoleRequest messages to all connected switches.
 
 Handling Role Requests is tricky. Roles are hard state on the switch and
 we can't query it so we need to make sure that we have consistent states
 on the switches. Whenever we send a role request to the set of connected 
 switches we need to make sure that we've sent the request to all of them 
 before we process the next change request. If a new switch connects, we 
 need to send it the current role and need to make sure that the current
 role doesn't change while we are doing it. We achieve this by synchronizing
 all these actions on Controller.roleChanger
 On the receive side: we need to make sure that we receive a reply for each 
 request we send and that the reply is consistent with the request we sent. 
 We'd also like to send the role request to the switch asynchronously in a
 separate thread so we don't block the REST API or other callers.
 
 There are potential ways to relax these sychrnonization requirements:
 - "Generation ID" for each role request. However, this would be most useful
   if it were global for the whole cluster
 - Regularly resend the controller's current role. Don't know whether this
   might have adverse effects on the switch. 
   
 Caveats:
 - No way to know if another controller (not in our controller cluster) 
   sends MASTER requests to connected switches. Then we would drop to
   slave role without knowing it. Could regularly resend the current role. 
   Ideally the switch would notify us if it demoted us. What happens if
   the other controller also regularly resends the same role request? 
   Or if the health check determines that
   a controller is dead but the controller is still talking to switches (maybe
   just its health check failed) and resending the master role request.... 
   We could try to detect if a switch demoted us to slave even if we think
   we are master (error messages on packet outs, e.g., when sending LLDPs)
 

 The general model of Role Request handling is as follows:
 
 - All role request messages are handled by this class. Class Controller 
   submits a role change request and the request gets queued. submitRequest
   takes a Collection of switches to which to send the request. We make a copy
   of this list. 
 - A thread takes these change requests from the queue and sends them to 
   all the switches (using our copy of the switch list). 
 - The OFSwitchImpl sends the request over the wire and puts the request
   into a queue of pending request (storing xid and role). We start a timeout 
   to make sure we eventually receive a reply from the switch. We use a single
   timeout for each request submitted using submitRequest()
 - After the timeout triggers we go over the list of switches again and
   check that a response has been received (by checking the head of the 
   OFSwitchImpl's queue of pending requests)
 - We handle requests and timeouts in the same thread. We use a priority queue
   to schedule them so we are guaranteed that they are processed in 
   the same order as they are submitted. If a request times out we drop
   the connection to this switch. 
 - Since we decouple submission of role change requests and actually sending
   them we cannot check a received role reply against the controller's current 
   role because the controller's current role could have changed again. 
 - Receiving Role Reply messages is handled by OFChannelHandler and
   OFSwitchImpl directly. The OFSwitchImpl checks if the received request 
   is as expected (xid and role match the head of the pending queue in 
   OFSwitchImpl). If so
   the switch updates its role. Otherwise the connection is dropped. If this
   is the first reply, the SWITCH_SUPPORTS_NX_ROLE attribute is set.
   Next, we call addSwitch(), removeSwitch() to update the list of active
   switches if appropriate.
 - If we receive an Error indicating that roles are not supported by the 
   switch, we set the SWITCH_SUPPORTS_NX_ROLE to false. We keep the 
   switch connection alive while in MASTER and EQUAL role. 
   (TODO: is this the right behavior for EQUAL??). If the role changes to
   SLAVE the switch connection is dropped (remember: only if the switch
   doesn't support role requests)  
   The expected behavior is that the switch will probably try to reconnect
   repeatedly (with some sort of exponential backoff), but after a  while 
   will give-up and move on to the next controller-IP configured on the 
   switch. This is the serial failover mechanism from OpenFlow spec v1.0.
   
 New switch connection:
 - Switch handshake is done without sending any role request messages.
 - After handshake completes, switch is added to the list of connected switches
   and we send the first role request message if role
   requests are enabled. If roles are disabled automatically promote switch to
   active switch list and clear FlowTable.
 - When we receive the first reply we proceed as above. In addition, if
   the role request is for MASTER we wipe the flow table. We do not wipe
   the flow table if the switch connected while role supported was disabled
   on the controller.</div>
</li>
</ul>
</div>
<div class="summary">
<ul class="blockList">
<li class="blockList">
<!-- ======== NESTED CLASS SUMMARY ======== -->
<ul class="blockList">
<li class="blockList"><a name="nested_class_summary">
<!--   -->
</a>
<h3>Nested Class Summary</h3>
<table class="overviewSummary" border="0" cellpadding="3" cellspacing="0" summary="Nested Class Summary table, listing nested classes, and an explanation">
<caption><span>Nested Classes</span><span class="tabEnd">&nbsp;</span></caption>
<tr>
<th class="colFirst" scope="col">Modifier and Type</th>
<th class="colLast" scope="col">Class and Description</th>
</tr>
<tr class="altColor">
<td class="colFirst"><code>protected static class&nbsp;</code></td>
<td class="colLast"><code><strong><a href="../../../../net/floodlightcontroller/core/internal/RoleChanger.RoleChangeTask.html" title="class in net.floodlightcontroller.core.internal">RoleChanger.RoleChangeTask</a></strong></code>
<div class="block">A queued task to be handled by the Role changer thread.</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><code>protected class&nbsp;</code></td>
<td class="colLast"><code><strong><a href="../../../../net/floodlightcontroller/core/internal/RoleChanger.RoleRequestWorker.html" title="class in net.floodlightcontroller.core.internal">RoleChanger.RoleRequestWorker</a></strong></code>&nbsp;</td>
</tr>
</table>
</li>
</ul>
<!-- =========== FIELD SUMMARY =========== -->
<ul class="blockList">
<li class="blockList"><a name="field_summary">
<!--   -->
</a>
<h3>Field Summary</h3>
<table class="overviewSummary" border="0" cellpadding="3" cellspacing="0" summary="Field Summary table, listing fields, and an explanation">
<caption><span>Fields</span><span class="tabEnd">&nbsp;</span></caption>
<tr>
<th class="colFirst" scope="col">Modifier and Type</th>
<th class="colLast" scope="col">Field and Description</th>
</tr>
<tr class="altColor">
<td class="colFirst"><code>protected static long</code></td>
<td class="colLast"><code><strong><a href="../../../../net/floodlightcontroller/core/internal/RoleChanger.html#DEFAULT_TIMEOUT">DEFAULT_TIMEOUT</a></strong></code>&nbsp;</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><code>protected long</code></td>
<td class="colLast"><code><strong><a href="../../../../net/floodlightcontroller/core/internal/RoleChanger.html#lastSubmitTime">lastSubmitTime</a></strong></code>&nbsp;</td>
</tr>
<tr class="altColor">
<td class="colFirst"><code>protected static org.slf4j.Logger</code></td>
<td class="colLast"><code><strong><a href="../../../../net/floodlightcontroller/core/internal/RoleChanger.html#log">log</a></strong></code>&nbsp;</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><code>protected java.util.concurrent.DelayQueue&lt;<a href="../../../../net/floodlightcontroller/core/internal/RoleChanger.RoleChangeTask.html" title="class in net.floodlightcontroller.core.internal">RoleChanger.RoleChangeTask</a>&gt;</code></td>
<td class="colLast"><code><strong><a href="../../../../net/floodlightcontroller/core/internal/RoleChanger.html#pendingTasks">pendingTasks</a></strong></code>&nbsp;</td>
</tr>
<tr class="altColor">
<td class="colFirst"><code>protected long</code></td>
<td class="colLast"><code><strong><a href="../../../../net/floodlightcontroller/core/internal/RoleChanger.html#timeout">timeout</a></strong></code>&nbsp;</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><code>protected java.lang.Thread</code></td>
<td class="colLast"><code><strong><a href="../../../../net/floodlightcontroller/core/internal/RoleChanger.html#workerThread">workerThread</a></strong></code>&nbsp;</td>
</tr>
</table>
</li>
</ul>
<!-- ======== CONSTRUCTOR SUMMARY ======== -->
<ul class="blockList">
<li class="blockList"><a name="constructor_summary">
<!--   -->
</a>
<h3>Constructor Summary</h3>
<table class="overviewSummary" border="0" cellpadding="3" cellspacing="0" summary="Constructor Summary table, listing constructors, and an explanation">
<caption><span>Constructors</span><span class="tabEnd">&nbsp;</span></caption>
<tr>
<th class="colOne" scope="col">Constructor and Description</th>
</tr>
<tr class="altColor">
<td class="colOne"><code><strong><a href="../../../../net/floodlightcontroller/core/internal/RoleChanger.html#RoleChanger()">RoleChanger</a></strong>()</code>&nbsp;</td>
</tr>
</table>
</li>
</ul>
<!-- ========== METHOD SUMMARY =========== -->
<ul class="blockList">
<li class="blockList"><a name="method_summary">
<!--   -->
</a>
<h3>Method Summary</h3>
<table class="overviewSummary" border="0" cellpadding="3" cellspacing="0" summary="Method Summary table, listing methods, and an explanation">
<caption><span>Methods</span><span class="tabEnd">&nbsp;</span></caption>
<tr>
<th class="colFirst" scope="col">Modifier and Type</th>
<th class="colLast" scope="col">Method and Description</th>
</tr>
<tr class="altColor">
<td class="colFirst"><code>protected void</code></td>
<td class="colLast"><code><strong><a href="../../../../net/floodlightcontroller/core/internal/RoleChanger.html#sendRoleRequest(java.util.Collection, net.floodlightcontroller.core.IFloodlightProviderService.Role, long)">sendRoleRequest</a></strong>(java.util.Collection&lt;<a href="../../../../net/floodlightcontroller/core/internal/OFSwitchImpl.html" title="class in net.floodlightcontroller.core.internal">OFSwitchImpl</a>&gt;&nbsp;switches,
               <a href="../../../../net/floodlightcontroller/core/IFloodlightProviderService.Role.html" title="enum in net.floodlightcontroller.core">IFloodlightProviderService.Role</a>&nbsp;role,
               long&nbsp;cookie)</code>
<div class="block">Send a role request message to switches.</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><code>void</code></td>
<td class="colLast"><code><strong><a href="../../../../net/floodlightcontroller/core/internal/RoleChanger.html#submitRequest(java.util.Collection, net.floodlightcontroller.core.IFloodlightProviderService.Role)">submitRequest</a></strong>(java.util.Collection&lt;<a href="../../../../net/floodlightcontroller/core/internal/OFSwitchImpl.html" title="class in net.floodlightcontroller.core.internal">OFSwitchImpl</a>&gt;&nbsp;switches,
             <a href="../../../../net/floodlightcontroller/core/IFloodlightProviderService.Role.html" title="enum in net.floodlightcontroller.core">IFloodlightProviderService.Role</a>&nbsp;role)</code>&nbsp;</td>
</tr>
<tr class="altColor">
<td class="colFirst"><code>protected void</code></td>
<td class="colLast"><code><strong><a href="../../../../net/floodlightcontroller/core/internal/RoleChanger.html#verifyRoleReplyReceived(java.util.Collection, long)">verifyRoleReplyReceived</a></strong>(java.util.Collection&lt;<a href="../../../../net/floodlightcontroller/core/internal/OFSwitchImpl.html" title="class in net.floodlightcontroller.core.internal">OFSwitchImpl</a>&gt;&nbsp;switches,
                       long&nbsp;cookie)</code>
<div class="block">Verify that switches have received a role reply message we sent earlier</div>
</td>
</tr>
</table>
<ul class="blockList">
<li class="blockList"><a name="methods_inherited_from_class_java.lang.Object">
<!--   -->
</a>
<h3>Methods inherited from class&nbsp;java.lang.Object</h3>
<code>clone, equals, finalize, getClass, hashCode, notify, notifyAll, toString, wait, wait, wait</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="details">
<ul class="blockList">
<li class="blockList">
<!-- ============ FIELD DETAIL =========== -->
<ul class="blockList">
<li class="blockList"><a name="field_detail">
<!--   -->
</a>
<h3>Field Detail</h3>
<a name="pendingTasks">
<!--   -->
</a>
<ul class="blockList">
<li class="blockList">
<h4>pendingTasks</h4>
<pre>protected&nbsp;java.util.concurrent.DelayQueue&lt;<a href="../../../../net/floodlightcontroller/core/internal/RoleChanger.RoleChangeTask.html" title="class in net.floodlightcontroller.core.internal">RoleChanger.RoleChangeTask</a>&gt; pendingTasks</pre>
</li>
</ul>
<a name="lastSubmitTime">
<!--   -->
</a>
<ul class="blockList">
<li class="blockList">
<h4>lastSubmitTime</h4>
<pre>protected&nbsp;long lastSubmitTime</pre>
</li>
</ul>
<a name="workerThread">
<!--   -->
</a>
<ul class="blockList">
<li class="blockList">
<h4>workerThread</h4>
<pre>protected&nbsp;java.lang.Thread workerThread</pre>
</li>
</ul>
<a name="timeout">
<!--   -->
</a>
<ul class="blockList">
<li class="blockList">
<h4>timeout</h4>
<pre>protected&nbsp;long timeout</pre>
</li>
</ul>
<a name="DEFAULT_TIMEOUT">
<!--   -->
</a>
<ul class="blockList">
<li class="blockList">
<h4>DEFAULT_TIMEOUT</h4>
<pre>protected static&nbsp;long DEFAULT_TIMEOUT</pre>
</li>
</ul>
<a name="log">
<!--   -->
</a>
<ul class="blockListLast">
<li class="blockList">
<h4>log</h4>
<pre>protected static&nbsp;org.slf4j.Logger log</pre>
</li>
</ul>
</li>
</ul>
<!-- ========= CONSTRUCTOR DETAIL ======== -->
<ul class="blockList">
<li class="blockList"><a name="constructor_detail">
<!--   -->
</a>
<h3>Constructor Detail</h3>
<a name="RoleChanger()">
<!--   -->
</a>
<ul class="blockListLast">
<li class="blockList">
<h4>RoleChanger</h4>
<pre>public&nbsp;RoleChanger()</pre>
</li>
</ul>
</li>
</ul>
<!-- ============ METHOD DETAIL ========== -->
<ul class="blockList">
<li class="blockList"><a name="method_detail">
<!--   -->
</a>
<h3>Method Detail</h3>
<a name="submitRequest(java.util.Collection, net.floodlightcontroller.core.IFloodlightProviderService.Role)">
<!--   -->
</a>
<ul class="blockList">
<li class="blockList">
<h4>submitRequest</h4>
<pre>public&nbsp;void&nbsp;submitRequest(java.util.Collection&lt;<a href="../../../../net/floodlightcontroller/core/internal/OFSwitchImpl.html" title="class in net.floodlightcontroller.core.internal">OFSwitchImpl</a>&gt;&nbsp;switches,
                 <a href="../../../../net/floodlightcontroller/core/IFloodlightProviderService.Role.html" title="enum in net.floodlightcontroller.core">IFloodlightProviderService.Role</a>&nbsp;role)</pre>
</li>
</ul>
<a name="sendRoleRequest(java.util.Collection, net.floodlightcontroller.core.IFloodlightProviderService.Role, long)">
<!--   -->
</a>
<ul class="blockList">
<li class="blockList">
<h4>sendRoleRequest</h4>
<pre>protected&nbsp;void&nbsp;sendRoleRequest(java.util.Collection&lt;<a href="../../../../net/floodlightcontroller/core/internal/OFSwitchImpl.html" title="class in net.floodlightcontroller.core.internal">OFSwitchImpl</a>&gt;&nbsp;switches,
                   <a href="../../../../net/floodlightcontroller/core/IFloodlightProviderService.Role.html" title="enum in net.floodlightcontroller.core">IFloodlightProviderService.Role</a>&nbsp;role,
                   long&nbsp;cookie)</pre>
<div class="block">Send a role request message to switches. This checks the capabilities 
 of the switch for understanding role request messaging. Currently we only 
 support the OVS-style role request message, but once the controller 
 supports OF 1.2, this function will also handle sending out the 
 OF 1.2-style role request message.</div>
<dl><dt><span class="strong">Parameters:</span></dt><dd><code>switches</code> - the collection of switches to send the request too</dd><dd><code>role</code> - the role to request</dd></dl>
</li>
</ul>
<a name="verifyRoleReplyReceived(java.util.Collection, long)">
<!--   -->
</a>
<ul class="blockListLast">
<li class="blockList">
<h4>verifyRoleReplyReceived</h4>
<pre>protected&nbsp;void&nbsp;verifyRoleReplyReceived(java.util.Collection&lt;<a href="../../../../net/floodlightcontroller/core/internal/OFSwitchImpl.html" title="class in net.floodlightcontroller.core.internal">OFSwitchImpl</a>&gt;&nbsp;switches,
                           long&nbsp;cookie)</pre>
<div class="block">Verify that switches have received a role reply message we sent earlier</div>
<dl><dt><span class="strong">Parameters:</span></dt><dd><code>switches</code> - the collection of switches to send the request too</dd><dd><code>cookie</code> - the cookie of the request</dd></dl>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<!-- ========= END OF CLASS DATA ========= -->
<!-- ======= START OF BOTTOM NAVBAR ====== -->
<div class="bottomNav"><a name="navbar_bottom">
<!--   -->
</a><a href="#skip-navbar_bottom" title="Skip navigation links"></a><a name="navbar_bottom_firstrow">
<!--   -->
</a>
<ul class="navList" title="Navigation">
<li><a href="../../../../overview-summary.html">Overview</a></li>
<li><a href="package-summary.html">Package</a></li>
<li class="navBarCell1Rev">Class</li>
<li><a href="class-use/RoleChanger.html">Use</a></li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../../deprecated-list.html">Deprecated</a></li>
<li><a href="../../../../index-files/index-1.html">Index</a></li>
<li><a href="../../../../help-doc.html">Help</a></li>
</ul>
</div>
<div class="subNav">
<ul class="navList">
<li><a href="../../../../net/floodlightcontroller/core/internal/OpenflowPipelineFactory.html" title="class in net.floodlightcontroller.core.internal"><span class="strong">Prev Class</span></a></li>
<li><a href="../../../../net/floodlightcontroller/core/internal/RoleChanger.RoleChangeTask.html" title="class in net.floodlightcontroller.core.internal"><span class="strong">Next Class</span></a></li>
</ul>
<ul class="navList">
<li><a href="../../../../index.html?net/floodlightcontroller/core/internal/RoleChanger.html" target="_top">Frames</a></li>
<li><a href="RoleChanger.html" target="_top">No Frames</a></li>
</ul>
<ul class="navList" id="allclasses_navbar_bottom">
<li><a href="../../../../allclasses-noframe.html">All Classes</a></li>
</ul>
<div>
<script type="text/javascript"><!--
  allClassesLink = document.getElementById("allclasses_navbar_bottom");
  if(window==top) {
    allClassesLink.style.display = "block";
  }
  else {
    allClassesLink.style.display = "none";
  }
  //-->
</script>
</div>
<div>
<ul class="subNavList">
<li>Summary:&nbsp;</li>
<li><a href="#nested_class_summary">Nested</a>&nbsp;|&nbsp;</li>
<li><a href="#field_summary">Field</a>&nbsp;|&nbsp;</li>
<li><a href="#constructor_summary">Constr</a>&nbsp;|&nbsp;</li>
<li><a href="#method_summary">Method</a></li>
</ul>
<ul class="subNavList">
<li>Detail:&nbsp;</li>
<li><a href="#field_detail">Field</a>&nbsp;|&nbsp;</li>
<li><a href="#constructor_detail">Constr</a>&nbsp;|&nbsp;</li>
<li><a href="#method_detail">Method</a></li>
</ul>
</div>
<a name="skip-navbar_bottom">
<!--   -->
</a></div>
<!-- ======== END OF BOTTOM NAVBAR ======= -->
</body>
</html>
